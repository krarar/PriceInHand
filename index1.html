<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتجر الحديث المطور</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
:root {
    --primary-color: #1abc9c; /* لون أساسي جديد أكثر عصرية */
    --secondary-color: #8e44ad; /* لون ثانوي جديد أكثر جاذبية */
    --accent-color: #e67e22;
    --background-color: #ecf0f1; /* لون خلفية أخف وأكثر إشراقًا */
    --text-color: #2c3e50;
    --card-background: #ffffff;
    --shadow-color: rgba(0, 0, 0, 0.15); /* زيادة في كثافة الظل لإضافة عمق */
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Tajawal', sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    transition: all 0.3s ease;
    font-size: 17px; /* زيادة بسيطة في حجم الخط لجعل النص أكثر وضوحًا */
    line-height: 1.6;
}

.header {
    background-color: var(--primary-color);
    color: white;
    padding: 1.25rem; /* زيادة في البادينغ لجعل العنوان أكثر تميزًا */
    position: sticky;
    top: 0;
    z-index: 1000;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 15px var(--shadow-color); /* زيادة الظل لإضفاء إحساس بالعمق */
}

.header h1 {
    font-size: 1.75rem; /* تكبير حجم العنوان ليكون أكثر لفتًا للانتباه */
    font-weight: 800;
    margin: 0;
}

.header-controls {
    display: flex;
    align-items: center;
    gap: 1.5rem; /* زيادة المسافات بين العناصر */
    margin-top: 0.5rem;
}

.search-container {
    position: relative;
    display: flex;
    align-items: center;
}

.search-icon {
    font-size: 1.5rem; /* تكبير أيقونة البحث لجعلها أكثر بروزًا */
    cursor: pointer;
    transition: color 0.3s ease;
}

.search-icon:hover {
    color: var(--secondary-color);
}

.header input {
    background-color: rgba(255, 255, 255, 0.25);
    border: none;
    border-radius: 2rem; /* زيادة انحناء الحواف لإضفاء نعومة */
    color: white;
    font-size: 1.125rem; /* تكبير حجم النص داخل حقل الإدخال */
    padding: 0.625rem 1.5rem;
    width: 0;
    transition: width 0.4s ease, padding 0.4s ease;
    position: absolute;
    right: 100%;
    top: 50%;
    transform: translateY(-50%);
}

.header input.active {
    width: 15rem; /* زيادة عرض الحقل عند تفعيله */
    padding: 0.625rem 3rem 0.625rem 1.5rem;
}

.header input::placeholder {
    color: rgba(255, 255, 255, 0.85); /* لون النص placeholder أكثر وضوحًا */
}

.sidebar-toggle, .dark-mode-toggle, .language-toggle {
    background-color: transparent;
    border: none;
    color: white;
    font-size: 1.5rem; /* تكبير حجم الأيقونات لجعلها أكثر عصرية */
    cursor: pointer;
    transition: color 0.3s ease;
    padding: 0.5rem; /* زيادة حجم البادينغ للأيقونات */
}

.sidebar-toggle:hover, .dark-mode-toggle:hover, .language-toggle:hover {
    color: var(--secondary-color);
}

.sidebar {
    height: 100%;
    width: 0;
    position: fixed;
    z-index: 1001;
    top: 0;
    right: 0;
    background-color: var(--card-background);
    overflow-x: hidden;
    transition: width 0.4s ease; /* تسريع التحول */
    padding-top: 4rem; /* زيادة بسيطة في البادينغ */
    box-shadow: -3px 0 12px var(--shadow-color); /* تحسين الظل لإضافة عمق */
}

.sidebar a {
    padding: 1rem 2rem; /* زيادة البادينغ */
    text-decoration: none;
    font-size: 1.25rem; /* تكبير حجم النص */
    color: var(--text-color);
    display: block;
    transition: color 0.3s, background-color 0.3s ease;
    border-bottom: 1px solid rgba(0,0,0,0.05); /* تخفيف حدة الحدود */
}

.sidebar a:hover {
    background-color: var(--secondary-color); /* تغيير اللون عند التمرير لزيادة التفاعل */
    color: white;
}

.sidebar .closebtn {
    position: absolute;
    top: 0;
    left: 2rem; /* زيادة المسافة لإتاحة المزيد من التباعد */
    font-size: 2.5rem; /* تكبير حجم زر الإغلاق */
    margin-right: 3rem;
}

.products {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* توسيع أعمدة الشبكة */
    gap: 2rem; /* زيادة المسافة بين البطاقات */
    padding: 2rem; /* زيادة البادينغ حول المنتجات */
    margin-bottom: 5rem; /* توسيع المسافة السفلية */
}

.product-card {
    background-color: var(--card-background);
    border-radius: 1rem; /* زيادة استدارة الحواف */
    box-shadow: 0 6px 18px var(--shadow-color); /* زيادة الظل لإضافة تأثير ثلاثي الأبعاد */
    overflow: hidden;
    transition: transform 0.4s, box-shadow 0.4s ease; /* جعل الحركة أكثر سلاسة */
    display: flex;
    flex-direction: column;
}

.product-card:hover {
    transform: translateY(-8px); /* زيادة الحركة عند التمرير */
    box-shadow: 0 10px 25px var(--shadow-color); /* زيادة الظل عند التمرير */
}

.product-images {
    position: relative;
    height: 260px; /* زيادة ارتفاع الصورة */
    overflow: hidden;
}

.product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.4s ease, transform 0.4s ease; /* تحسين الحركات لجعلها أكثر سلاسة */
}

.product-image:not(:first-child) {
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
}

.product-card:hover .product-image {
    transform: scale(1.08); /* زيادة تكبير الصورة عند التمرير */
}

.image-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(255, 255, 255, 0.85); /* زيادة الشفافية لإبراز الصورة */
    color: var(--text-color);
    border: none;
    font-size: 1.5rem; /* تكبير الأزرار */
    padding: 0.75rem;
    cursor: pointer;
    transition: background-color 0.3s, opacity 0.3s ease;
    opacity: 0;
}

.product-card:hover .image-nav {
    opacity: 1;
}

.image-nav:hover {
    background-color: rgba(255, 255, 255, 1); /* زيادة الوضوح عند التمرير */
}

.product-card:hover .image-nav {
    opacity: 1;
}

.image-nav:hover {
    background-color: rgba(255, 255, 255, 1); /* تحسين وضوح اللون عند التمرير */
}

.image-nav.prev {
    left: 1rem; /* زيادة المسافة لتوفير تباعد أفضل */
}

.image-nav.next {
    right: 1rem; /* زيادة المسافة لتوفير تباعد أفضل */
}

.product-info {
    padding: 1.5rem; /* زيادة البادينغ لتوفير مساحة أفضل للمحتوى */
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.product-info h3 {
    margin-bottom: 0.75rem; /* زيادة المسافة بين العنوان والسعر */
    color: var(--primary-color);
    font-size: 1.375rem; /* تكبير حجم العنوان لجعله أكثر بروزًا */
}

.price {
    font-weight: bold;
    color: var(--accent-color);
    margin-bottom: 1rem; /* زيادة المسافة بين السعر والعناصر الأخرى */
    font-size: 1.25rem; /* تكبير حجم النص للسعر */
}

.action-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: auto;
}

.action-button {
    background-color: transparent;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    font-size: 1.25rem; /* تكبير حجم الأزرار */
    transition: color 0.3s ease; /* تحسين انتقال الألوان */
    display: flex;
    align-items: center;
}

.action-button:hover {
    color: var(--primary-color); /* تحسين تأثير التمرير لجعل الأزرار أكثر تفاعلية */
}

.action-count {
    margin-right: 0.5rem; /* زيادة المسافة بين الأيقونة والعداد */
    font-size: 1rem; /* تكبير حجم العداد */
    background-color: var(--primary-color);
    color: white;
    border-radius: 50%;
    padding: 0.25rem 0.5rem; /* زيادة حجم البادينغ */
}

.buy-button {
    background-color: var(--secondary-color);
    color: white;
    padding: 0.875rem 1.5rem; /* زيادة البادينغ للأزرار لتكون أكثر وضوحًا */
    border: none;
    border-radius: 2rem; /* زيادة استدارة الحواف لإضفاء طابع عصري */
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease; /* تحسين التأثيرات عند التفاعل */
    width: 100%;
    margin-top: 1rem; /* زيادة المسافة العلوية للزر */
    font-size: 1.125rem; /* تكبير النص داخل الأزرار */
    font-weight: bold;
    text-transform: uppercase;
}

.buy-button:hover {
    background-color: #2ecc71; /* تحسين لون التمرير لجعل الزر أكثر بروزًا */
    transform: translateY(-3px); /* تحسين حركة الزر عند التمرير */
    box-shadow: 0 6px 12px rgba(46, 204, 113, 0.35); /* زيادة الظل لجعل الزر يبدو مرتفعًا */
}

.popup {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--card-background);
    padding: 25px; /* زيادة البادينغ لتحسين التباعد */
    border-radius: 20px; /* زيادة استدارة الحواف لتصبح أكثر نعومة */
    box-shadow: 0 12px 30px var(--shadow-color); /* زيادة كثافة الظل لإضفاء عمق */
    z-index: 1002;
    text-align: center;
    max-width: 85%; /* جعل العرض أكثر مرونة */
    width: 450px; /* زيادة العرض */
}

.popup h3 {
    margin-bottom: 25px; /* زيادة المسافة السفلية للعناوين */
    color: var(--primary-color);
    font-size: 1.75rem; /* تكبير حجم العناوين */
    font-weight: bold;
}

.popup button {
    padding: 0.875rem 1.5rem; /* زيادة البادينغ داخل الأزرار */
    margin: 0.75rem; /* زيادة المسافة بين الأزرار */
    background-color: var(--secondary-color);
    color: white;
    border: none;
    border-radius: 2rem; /* زيادة استدارة الأزرار */
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease; /* تحسين التأثيرات عند التفاعل */
    font-size: 1.125rem; /* تكبير النص داخل الأزرار */
    font-weight: bold;
}

.popup button:hover {
    background-color: #2ecc71; /* تحسين اللون عند التمرير */
    transform: translateY(-3px); /* جعل التفاعل مع الأزرار أكثر وضوحًا */
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.35); /* تحسين الظل عند التمرير */
}

.timer {
    font-size: 2.5rem; /* تكبير حجم الخط */
    color: var(--accent-color);
    margin-bottom: 25px; /* زيادة المسافة السفلية */
    font-weight: bold;
}

.popup .closebtn {
    position: absolute;
    top: 12px; /* تعديل المسافة العلوية */
    right: 12px; /* تعديل المسافة الجانبية */
    background-color: transparent;
    border: none;
    font-size: 26px; /* تكبير أيقونة الإغلاق */
    cursor: pointer;
    color: var(--text-color);
}

.popup .closebtn:hover {
    color: var(--accent-color); /* تحسين اللون عند التمرير */
}

.price-display {
    font-size: 1.75rem; /* تكبير حجم النص للسعر */
    color: var(--primary-color);
    margin-bottom: 1.5rem; /* زيادة المسافة السفلية */
    font-weight: bold;
}

.add-product-btn {
    position: fixed;
    bottom: 35px; /* زيادة المسافة السفلية */
    left: 35px; /* زيادة المسافة الجانبية */
    background-color: var(--primary-color);
    color: white;
    padding: 17px; /* زيادة حجم البادينغ */
    border-radius: 50%; /* الحفاظ على الشكل الدائري */
    font-size: 26px; /* تكبير حجم الأيقونة */
    cursor: pointer;
    box-shadow: 0 6px 18px var(--shadow-color); /* زيادة الظل لتصبح أكثر وضوحًا */
    z-index: 1003;
}

.add-product-btn:hover {
    background-color: var(--secondary-color);
    transform: scale(1.15); /* زيادة التأثير عند التمرير */
    box-shadow: 0 8px 20px var(--shadow-color); /* تحسين الظل عند التمرير */
}


.add-product-form {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--card-background);
    padding: 1.5rem; /* زيادة البادينغ لتوفير مساحة أفضل */
    border-radius: 1.25rem; /* زيادة انحناء الحواف لجعلها أكثر نعومة */
    box-shadow: 0 12px 30px var(--shadow-color); /* زيادة كثافة الظل لإضفاء عمق */
    z-index: 1002;
    text-align: right;
    max-width: 85%; /* تقليص الحد الأقصى للعرض */
    width: 28rem; /* توسيع العرض */
}

.add-product-form h3 {
    margin-bottom: 1.5rem; /* زيادة المسافة السفلية للعناوين */
    color: var(--primary-color);
    font-size: 1.75rem; /* تكبير حجم العنوان */
    font-weight: bold;
}

.add-product-form input,
.add-product-form select {
    width: 100%;
    padding: 0.875rem; /* زيادة البادينغ داخل الحقول */
    margin-bottom: 1rem; /* زيادة المسافة بين الحقول */
    border: 1px solid #ccc; /* تحسين لون الحدود */
    border-radius: 0.5rem; /* زيادة استدارة الحواف لجعلها أكثر نعومة */
    font-size: 1.125rem; /* تكبير حجم الخط */
}

.add-product-form button {
    background-color: var(--secondary-color);
    color: white;
    padding: 0.875rem 1.5rem; /* زيادة البادينغ للأزرار */
    border: none;
    border-radius: 2rem; /* زيادة استدارة الحواف للأزرار */
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease; /* تحسين التأثيرات */
    font-size: 1.125rem; /* تكبير النص داخل الأزرار */
    font-weight: bold;
}

.add-product-form button:hover {
    background-color: #2ecc71; /* تحسين لون التمرير */
    transform: translateY(-3px); /* تحسين حركة الأزرار عند التفاعل */
    box-shadow: 0 6px 15px rgba(46, 204, 113, 0.35); /* زيادة الظل */
}

.dark-mode {
    --primary-color: #3498db;
    --secondary-color: #2ecc71;
    --accent-color: #e74c3c;
    --background-color: #2c3e50;
    --text-color: #ecf0f1;
    --card-background: #34495e;
    --shadow-color: rgba(0, 0, 0, 0.3); /* تحسين الظل في الوضع الداكن */
}

.cart-button {
    position: fixed;
    bottom: 2.5rem; /* زيادة المسافة السفلية للزر */
    right: 2.5rem; /* زيادة المسافة الجانبية */
    background-color: var(--primary-color);
    color: white;
    padding: 1rem; /* زيادة حجم البادينغ للزر */
    border-radius: 50%; /* الحفاظ على الشكل الدائري */
    font-size: 1.25rem; /* تكبير حجم النص */
    border: none;
    cursor: pointer;
    z-index: 1002;
    box-shadow: 0 5px 15px var(--shadow-color); /* زيادة الظل */
    transition: 0.3s ease; /* تحسين التأثير عند التمرير */
}

.cart-button:hover {
    background-color: var(--secondary-color);
    transform: translateY(-5px); /* تحسين الحركة عند التفاعل */
    box-shadow: 0 8px 20px var(--shadow-color); /* تحسين الظل عند التفاعل */
}

.cart-count {
    position: absolute;
    top: -0.3125rem;
    right: -0.3125rem;
    background-color: var(--accent-color);
    color: white;
    border-radius: 50%;
    padding: 0.25rem 0.5rem; /* زيادة البادينغ داخل العداد */
    font-size: 0.875rem; /* تكبير حجم النص للعداد */
}

@media screen and (max-width: 768px) {
    body {
        font-size: 15px; /* تحسين حجم النص في الشاشات الصغيرة */
    }

    .header {
        flex-direction: column;
        align-items: flex-start;
        padding: 1rem; /* زيادة حجم البادينغ */
    }

    .header h1 {
        font-size: 1.5rem; /* تكبير العنوان */
        margin-bottom: 0.75rem; /* زيادة المسافة السفلية للعناوين */
    }
}

.header-controls {
    width: 100%;
    justify-content: space-between;
    margin-top: 0.75rem; /* زيادة المسافة العلوية */
}

.header input.active {
    width: 10rem; /* زيادة عرض حقل البحث عند التفعيل */
}

.products {
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); /* زيادة الحد الأدنى لعرض الأعمدة */
    gap: 1.25rem; /* زيادة المسافات بين المنتجات */
    padding: 1.25rem; /* زيادة البادينغ حول المنتجات */
}

.product-images {
    height: 220px; /* زيادة ارتفاع الصور */
}

.product-info {
    padding: 1.25rem; /* زيادة البادينغ للمعلومات */
}

.product-info h3 {
    font-size: 1.25rem; /* تكبير حجم العناوين لتكون أكثر وضوحًا */
    margin-bottom: 0.75rem; /* زيادة المسافة السفلية للعناوين */
}

.price {
    font-size: 1.125rem; /* تكبير حجم السعر */
    font-weight: bold; /* جعل السعر أكثر وضوحًا */
    color: var(--accent-color); /* استخدام اللون الخاص بالسعر */
    margin-bottom: 1rem; /* زيادة المسافة السفلية للسعر */
}

    
    </style>
</head>
<body>
   <div class="header">
    <h1>المتجر الحديث المطور</h1>
    <div class="header-controls">
        <div class="search-container">
            <i class="fas fa-search search-icon" onclick="toggleSearch()"></i>
            <input type="text" id="searchInput" placeholder="البحث عن المنتجات...">
        </div>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()">
            <i class="fas fa-moon"></i>
        </button>
        <button class="language-toggle" onclick="toggleLanguage()">EN</button>
        <button class="sidebar-toggle" onclick="openSidebar()">
            <i class="fas fa-bars"></i>
        </button>
    </div>
</div>
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeSidebar()">&times;</a>
        <a href="#" onclick="fetchProducts()"><i class="fas fa-home"></i> الرئيسية</a>
        <a href="#" onclick="showLikedProducts()"><i class="fas fa-heart"></i> الإعجابات</a>
        <a href="#" onclick="showFavoriteProducts()"><i class="fas fa-star"></i> المفضلة</a>
        <a href="#" onclick="showSavedProducts()"><i class="fas fa-bookmark"></i> المحفوظات</a>
        <a href="#" onclick="showCategories()"><i class="fas fa-list"></i> التصنيفات</a>
        <a href="#" onclick="showOffers()"><i class="fas fa-percentage"></i> العروض</a>
    </div>

    <div class="products" id="products">
        <!-- Products will be dynamically loaded here -->
    </div>
      <!-- Existing HTML structure remains unchanged -->

    <!-- Add this new button for the cart -->
    <button class="cart-button" onclick="showCart()">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-count" id="cartCount">0</span>
    </button>

    <div id="pricePopup" class="popup">
        <h3>جاري تحديد السعر الخاص بك...</h3>
        <div id="countdown" class="timer">3</div>
        <div id="randomPrice" class="price-display">---</div>
        <button onclick="closePopup()">إغلاق</button>
        <button id="addToCartBtn" class="cart-button" onclick="addToCart()" style="display: none;">إضافة إلى السلة</button>
    </div>
    

    <button class="add-product-btn" onclick="toggleAddProductForm()"><i class="fas fa-plus"></i></button>

    <div class="add-product-form" id="addProductForm">
        <h3>إضافة منتج جديد</h3>
        <input type="text" id="newProductName" placeholder="اسم المنتج">
        <input type="file" id="newProductImage" accept="image/*" multiple>
        <input type="number" id="newProductPriceOriginal" placeholder="السعر الأصلي">
        <input type="number" id="newProductPriceDiscount" placeholder="سعر الخصم">
        <input type="number" id="newProductPriceSuperDiscount" placeholder="سعر الخصم الفائق">
        <select id="newProductCategory">
            <option value="">اختر التصنيف</option>
            <option value="electronics">إلكترونيات</option>
            <option value="clothing">ملابس</option>
            <option value="home">منزل وحديقة</option>
            <option value="beauty">الجمال والعناية الشخصية</option>
        </select>
        <button onclick="addProduct()">إضافة المنتج</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        let userId = localStorage.getItem('userId');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('userId', userId);
        }

        let currentLanguage = 'ar';
        let isDarkMode = false;
        let currentProductId = null;
        let currentPrice = null;

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            const darkModeToggle = document.querySelector('.dark-mode-toggle i');
            darkModeToggle.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
            document.documentElement.lang = currentLanguage;
            document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
            updateLanguage();
        }

         // Add this new function to handle adding items to cart
         function toggleCart(productId) {
            const productRef = database.ref('products/' + productId + '/cart/' + userId);
            productRef.once('value').then((snapshot) => {
                if (snapshot.val()) {
                    productRef.remove();
                } else {
                    productRef.set(true);
                }
                updateCartCount();
            });
        }
  // Add this new function to update the cart count
  function updateCartCount() {
    const cartCountElement = document.getElementById('cartCount');
    database.ref('carts/' + userId).once('value', (snapshot) => {
        const cart = snapshot.val();
        const count = cart ? Object.keys(cart).length : 0;
        cartCountElement.textContent = count;
    });
}
 // Add this new function to show cart items
 function showCart() {
    const productsContainer = document.getElementById('products');
    productsContainer.innerHTML = '<h2>سلة التسوق</h2>';
    database.ref('carts/' + userId).once('value', (snapshot) => {
        const cart = snapshot.val();
        if (cart) {
            for (let productId in cart) {
                const productCard = createCartItemCard(productId, cart[productId]);
                productsContainer.innerHTML += productCard;
            }
            productsContainer.innerHTML += `
                <button id="checkoutButton" class="buy-button" onclick="goToCheckout()">
                    إتمام الشراء
                </button>
            `;
        } else {
            productsContainer.innerHTML += '<p>السلة فارغة</p>';
        }
    });
}

function goToCheckout() {
    window.location.href = 'checkout.html';
}
function createCartItemCard(productId, product) {
    return `
        <div class="product-card" data-product-id="${productId}">
            <div class="product-images">
                <img src="${product.images[0]}" alt="${product.name}" class="product-image" style="width: 250px; height: 250px;">
            </div>
            <div class="product-info">
                <h3>${product.name}</h3>
                <p class="price">السعر المختار: $${product.price.toFixed(2)}</p>
                <p class="price">السعر الأصلي: $${product.priceOriginal}</p>
                <p class="price">سعر الخصم: $${product.priceDiscount}</p>
                <p class="price">سعر الخصم الفائق: $${product.priceSuperDiscount}</p>
                <button class="action-button" onclick="removeFromCart('${productId}')">
                    <i class="fas fa-trash"></i> إزالة من السلة
                </button>
            </div>
        </div>
    `;
}
function removeFromCart(productId) {
    database.ref('carts/' + userId + '/' + productId).remove()
        .then(() => {
            alert('تم إزالة المنتج من السلة بنجاح!');
            showCart();
            updateCartCount();
        })
        .catch((error) => {
            alert('حدث خطأ أثناء إزالة المنتج من السلة.');
        });
}

window.onload = () => {
    fetchProducts();
    updateLanguage();
    updateCartCount();
};

        function updateLanguage() {
            const translations = {
                ar: {
                    title: 'المتجر الحديث المطور',
                    search: 'البحث عن المنتجات...',
                    home: 'الرئيسية',
                    likes: 'الإعجابات',
                    favorites: 'المفضلة',
                    saved: 'المحفوظات',
                    categories: 'التصنيفات',
                    offers: 'العروض',
                    addProduct: 'إضافة منتج جديد',
                    productName: 'اسم المنتج',
                    originalPrice: 'السعر الأصلي',
                    discountPrice: 'سعر الخصم',
                    superDiscountPrice: 'سعر الخصم الفائق',
                    category: 'اختر التصنيف',
                    add: 'إضافة المنتج',
                    determiningPrice: 'جاري تحديد السعر الخاص بك...',
                    close: 'إغلاق',
                    buyNow: 'شراء الآن',
                    languageToggle: 'English'
                },
                en: {
                    title: 'Advanced Modern Store',
                    search: 'Search for products...',
                    home: 'Home',
                    likes: 'Likes',
                    favorites: 'Favorites',
                    saved: 'Saved',
                    categories: 'Categories',
                    offers: 'Offers',
                    addProduct: 'Add New Product',
                    productName: 'Product Name',
                    originalPrice: 'Original Price',
                    discountPrice: 'Discount Price',
                    superDiscountPrice: 'Super Discount Price',
                    category: 'Choose Category',
                    add: 'Add Product',
                    determiningPrice: 'Determining Your Price...',
                    close: 'Close',
                    buyNow: 'Buy Now',
                    languageToggle: 'العربية'
                }
            };

            document.querySelector('.header h1').textContent = translations[currentLanguage].title;
            document.getElementById('searchInput').placeholder = translations[currentLanguage].search;
            document.querySelectorAll('.sidebar a')[1].innerHTML = `<i class="fas fa-home"></i> ${translations[currentLanguage].home}`;
            document.querySelectorAll('.sidebar a')[2].innerHTML = `<i class="fas fa-heart"></i> ${translations[currentLanguage].likes}`;
            document.querySelectorAll('.sidebar a')[3].innerHTML = `<i class="fas fa-star"></i> ${translations[currentLanguage].favorites}`;
            document.querySelectorAll('.sidebar a')[4].innerHTML = `<i class="fas fa-bookmark"></i> ${translations[currentLanguage].saved}`;
            document.querySelectorAll('.sidebar a')[5].innerHTML = `<i class="fas fa-list"></i> ${translations[currentLanguage].categories}`;
            document.querySelectorAll('.sidebar a')[6].innerHTML = `<i class="fas fa-percentage"></i> ${translations[currentLanguage].offers}`;
            document.querySelector('#addProductForm h3').textContent = translations[currentLanguage].addProduct;
            document.getElementById('newProductName').placeholder = translations[currentLanguage].productName;
            document.getElementById('newProductPriceOriginal').placeholder = translations[currentLanguage].originalPrice;
            document.getElementById('newProductPriceDiscount').placeholder = translations[currentLanguage].discountPrice;
            document.getElementById('newProductPriceSuperDiscount').placeholder = translations[currentLanguage].superDiscountPrice;
            document.getElementById('newProductCategory').options[0].text = translations[currentLanguage].category;
            document.querySelector('#addProductForm button').textContent = translations[currentLanguage].add;
            document.querySelector('#pricePopup h3').textContent = translations[currentLanguage].determiningPrice;
            document.querySelector('#pricePopup button').textContent = translations[currentLanguage].close;
            document.getElementById('purchaseButton').textContent = translations[currentLanguage].buyNow;
            document.querySelector('.language-toggle').textContent = translations[currentLanguage].languageToggle;

            fetchProducts();
        }

        function openSidebar() {
            document.getElementById("mySidebar").style.width = "250px";
        }

        function closeSidebar() {
            document.getElementById("mySidebar").style.width = "0";
        }

       // Update the fetchProducts function to also update the cart count
       function fetchProducts() {
        const productsContainer = document.getElementById('products');
        database.ref('products').on('value', (snapshot) => {
            const products = snapshot.val();
            productsContainer.innerHTML = '';
            for (let key in products) {
                const product = products[key];
                const productCard = createProductCard(key, product);
                productsContainer.innerHTML += productCard;
            }
            initializeImageSliders();
            updateCartCount();
        });
    }
 // Update the createProductCard function to include the cart button
 function createProductCard(key, product) {
    const images = product.images || [product.image];
    const imagesHtml = images.map((img, index) => `
        <img src="${img}" alt="${product.name}" class="product-image" style="opacity: ${index === 0 ? 1 : 0};">
    `).join('');

    const translation = {
        ar: {
            priceOriginal: 'السعر الأصلي',
            priceDiscount: 'سعر الخصم',
            priceSuperDiscount: 'سعر الخصم الفائق',
            buyNow: 'اشتري الآن'
        },
        en: {
            priceOriginal: 'Original Price',
            priceDiscount: 'Discount Price',
            priceSuperDiscount: 'Super Discount Price',
            buyNow: 'Buy Now'
        }
    };

    return `
        <div class="product-card" data-product-id="${key}">
            <div class="product-images">
                ${imagesHtml}
                <button class="image-nav prev" onclick="changeImage('${key}', -1)">❮</button>
                <button class="image-nav next" onclick="changeImage('${key}', 1)">❯</button>
            </div>
            <div class="product-info">
                <h3>${product.name}</h3>
                <p class="price">${translation[currentLanguage].priceOriginal}: $${product.priceOriginal}</p>
                <p class="price">${translation[currentLanguage].priceDiscount}: $${product.priceDiscount}</p>
                <p class="price">${translation[currentLanguage].priceSuperDiscount}: $${product.priceSuperDiscount}</p>
                <div class="action-buttons">
                    <button class="action-button" onclick="toggleLike('${key}')">
                        <i class="fas fa-heart ${product.likes && product.likes[userId] ? 'text-danger' : ''}"></i>
                        <span class="action-count">${countObjectProperties(product.likes)}</span>
                    </button>
                    <button class="action-button" onclick="toggleFavorite('${key}')">
                        <i class="fas fa-star ${product.favorites && product.favorites[userId] ? 'text-warning' : ''}"></i>
                        <span class="action-count">${countObjectProperties(product.favorites)}</span>
                    </button>
                    <button class="action-button" onclick="toggleSave('${key}')">
                        <i class="fas fa-bookmark ${product.saved && product.saved[userId] ? 'text-primary' : ''}"></i>
                        <span class="action-count">${countObjectProperties(product.saved)}</span>
                    </button>
                    <button class="action-button" onclick="toggleCart('${key}')">
                        <i class="fas fa-shopping-cart ${product.cart && product.cart[userId] ? 'text-success' : ''}"></i>
                        <span class="action-count">${countObjectProperties(product.cart)}</span>
                    </button>
                </div>
                <button class="buy-button" onclick="showPricePopup('${key}')">${translation[currentLanguage].buyNow}</button>
            </div>
        </div>
    `;
}


        function countObjectProperties(obj) {
            return obj ? Object.keys(obj).length : 0;
        }

        function changeImage(productId, direction) {
            const productCard = document.querySelector(`.product-card[data-product-id="${productId}"]`);
            const images = productCard.querySelectorAll('.product-image');
            let activeIndex = Array.from(images).findIndex(img => img.style.opacity === '1');
            images[activeIndex].style.opacity = '0';
            activeIndex = (activeIndex + direction + images.length) % images.length;
            images[activeIndex].style.opacity = '1';
        }

        function initializeImageSliders() {
            const productCards = document.querySelectorAll('.product-card');
            productCards.forEach(card => {
                let startX;
                let isSwiping = false;
                card.addEventListener('touchstart', e => {
                    startX = e.touches[0].clientX;
                    isSwiping = true;
                });
                card.addEventListener('touchmove', e => {
                    if (!isSwiping) return;
                    const currentX = e.touches[0].clientX;
                    const diff = startX - currentX;
                    if (Math.abs(diff) > 50) {
                        changeImage(card.dataset.productId, diff > 0 ? 1 : -1);
                        isSwiping = false;
                    }
                });
                card.addEventListener('touchend', () => {
                    isSwiping = false;
                });
            });
        }

           function toggleLike(productId) {
            const productRef = database.ref('products/' + productId + '/likes/' + userId);
            productRef.once('value').then((snapshot) => {
                if (snapshot.val()) {
                    productRef.remove();
                } else {
                    productRef.set(true);
                }
            });
        }

        function toggleFavorite(productId) {
            const productRef = database.ref('products/' + productId + '/favorites/' + userId);
            productRef.once('value').then((snapshot) => {
                if (snapshot.val()) {
                    productRef.remove();
                } else {
                    productRef.set(true);
                }
            });
        }

        function toggleSave(productId) {
            const productRef = database.ref('products/' + productId + '/saved/' + userId);
            productRef.once('value').then((snapshot) => {
                if (snapshot.val()) {
                    productRef.remove();
                } else {
                    productRef.set(true);
                }
            });
        }

        async function addProduct() {
            const name = document.getElementById('newProductName').value;
            const imageFiles = document.getElementById('newProductImage').files;
            const priceOriginal = document.getElementById('newProductPriceOriginal').value;
            const priceDiscount = document.getElementById('newProductPriceDiscount').value;
            const priceSuperDiscount = document.getElementById('newProductPriceSuperDiscount').value;

            if (!name || imageFiles.length === 0 || !priceOriginal || !priceDiscount || !priceSuperDiscount) {
                alert('الرجاء ملء جميع الحقول');
                return;
            }

            try {
                const imageUrls = await Promise.all(Array.from(imageFiles).map(uploadImage));
                const newProduct = {
                    name: name,
                    images: imageUrls,
                    priceOriginal: priceOriginal,
                    priceDiscount: priceDiscount,
                    priceSuperDiscount: priceSuperDiscount
                };

                database.ref('products').push(newProduct, function(error) {
                    if (error) {
                        alert('خطأ في إضافة المنتج: ' + error);
                    } else {
                        alert('تمت إضافة المنتج بنجاح!');
                        toggleAddProductForm();
                    }
                });
            } catch (error) {
                alert('خطأ في رفع الصور: ' + error);
            }
        }

        async function uploadImage(imageFile) {
            const storageRef = storage.ref('product_images/' + Date.now() + '_' + imageFile.name);
            await storageRef.put(imageFile);
            return await storageRef.getDownloadURL();
        }

        function toggleAddProductForm() {
            const form = document.getElementById('addProductForm');
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('mySidebar');
            sidebar.style.left = sidebar.style.left === '0px' ? '-250px' : '0px';
        }

        function searchProducts() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const products = document.querySelectorAll('.product-card');
            products.forEach(product => {
                const productName = product.querySelector('h3').innerText.toLowerCase();
                product.style.display = productName.includes(searchInput) ? 'block' : 'none';
            });
        }

       
        function showPricePopup(productId) {
            currentProductId = productId;
            const popup = document.getElementById('pricePopup');
            const countdown = document.getElementById('countdown');
            const addToCartBtn = document.getElementById('addToCartBtn');
            let timer = 3;
            countdown.innerText = timer;

            const lastPurchaseTime = localStorage.getItem(`lastPurchase_${productId}_${userId}`);
            const currentTime = Date.now();

            if (lastPurchaseTime && currentTime - lastPurchaseTime < 3600000) {
                alert('يمكنك إضافة هذا المنتج مرة واحدة فقط كل ساعة. الرجاء المحاولة لاحقاً.');
                return;
            }

            addToCartBtn.style.display = 'none';
            popup.style.display = 'block';

            const countdownInterval = setInterval(() => {
                timer--;
                countdown.innerText = timer;
                if (timer === 0) {
                    clearInterval(countdownInterval);
                    selectRandomPrice(productId);
                    addToCartBtn.style.display = 'inline-block';
                }
            }, 1000);
        }

        function closePopup() {
            const popup = document.getElementById('pricePopup');
            popup.style.display = 'none';
        }

        function selectRandomPrice(productId) {
            const randomPriceDisplay = document.getElementById('randomPrice');
            database.ref('products/' + productId).once('value', (snapshot) => {
                const product = snapshot.val();
                const prices = [
                    parseFloat(product.priceOriginal),
                    parseFloat(product.priceDiscount),
                    parseFloat(product.priceSuperDiscount)
                ];
                currentPrice = prices[Math.floor(Math.random() * prices.length)];
                randomPriceDisplay.innerText = `السعر الخاص بك: $${currentPrice.toFixed(2)}`;

                localStorage.setItem(`lastPurchase_${productId}_${userId}`, Date.now().toString());
            });
        }

        function addToCart() {
            if (currentProductId && currentPrice) {
                database.ref('products/' + currentProductId).once('value', (snapshot) => {
                    const product = snapshot.val();
                    const cartRef = database.ref('carts/' + userId + '/' + currentProductId);
                    cartRef.set({
                        name: product.name,
                        images: product.images || [product.image],
                        price: currentPrice,
                        priceOriginal: product.priceOriginal,
                        priceDiscount: product.priceDiscount,
                        priceSuperDiscount: product.priceSuperDiscount,
                        timestamp: Date.now()
                    }, (error) => {
                        if (error) {
                            alert('حدث خطأ أثناء إضافة المنتج إلى السلة.');
                        } else {
                            alert('تمت إضافة المنتج إلى السلة بنجاح!');
                            closePopup();
                            updateCartCount();
                        }
                    });
                });
            }
        }

function redirectToPurchase(productId) {
    // استرجاع تفاصيل المنتج من قاعدة البيانات
    database.ref('products/' + productId).once('value', (snapshot) => {
        const product = snapshot.val();

        // تخزين تفاصيل المنتج في localStorage
        const productDetails = {
            name: product.name,
            images: product.images || [product.image],
            priceOriginal: product.priceOriginal,
            priceDiscount: product.priceDiscount,
            priceSuperDiscount: product.priceSuperDiscount
        };
        
        localStorage.setItem('selectedProduct', JSON.stringify(productDetails));
        
        // الانتقال إلى صفحة إتمام الشراء
        window.location.href = "purchase.html";
    });
}




        function showLikedProducts() {
            const productsContainer = document.getElementById('products');
            productsContainer.innerHTML = '<h2>المنتجات التي أعجبتك</h2>';
            database.ref('products').once('value', (snapshot) => {
                const products = snapshot.val();
                for (let key in products) {
                    const product = products[key];
                    if (product.likes && product.likes[userId]) {
                        const productCard = createProductCard(key, product);
                        productsContainer.innerHTML += productCard;
                    }
                }
                initializeImageSliders();
            });
        }

        function showFavoriteProducts() {
            const productsContainer = document.getElementById('products');
            productsContainer.innerHTML = '<h2>منتجاتك المفضلة</h2>';
            database.ref('products').once('value', (snapshot) => {
                const products = snapshot.val();
                for (let key in products) {
                    const product = products[key];
                    if (product.favorites && product.favorites[userId]) {
                        const productCard = createProductCard(key, product);
                        productsContainer.innerHTML += productCard;
                    }
                }
                initializeImageSliders();
            });
        }

        function showSavedProducts() {
            const productsContainer = document.getElementById('products');
            productsContainer.innerHTML = '<h2>المنتجات المحفوظة</h2>';
            database.ref('products').once('value', (snapshot) => {
                const products = snapshot.val();
                for (let key in products) {
                    const product = products[key];
                    if (product.saved && product.saved[userId]) {
                        const productCard = createProductCard(key, product);
                        productsContainer.innerHTML += productCard;
                    }
                }
                initializeImageSliders();
            });
        }
        

        window.onload = () => {
            fetchProducts();
            updateLanguage();
            updateCartCount();
        };
        
        

        function toggleSearch() {
    const searchInput = document.getElementById('searchInput');
    searchInput.classList.toggle('active');
    if (searchInput.classList.contains('active')) {
        searchInput.focus();
    }
}



function transferCartToCheckout() {
    const cartItems = [];
    database.ref('carts/' + userId).once('value', (snapshot) => {
        const cart = snapshot.val();
        if (cart) {
            for (let productId in cart) {
                cartItems.push({
                    productId: productId,
                    ...cart[productId]
                });
            }
            // Store cart items in localStorage
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            // Redirect to checkout page
            window.location.href = 'checkout.html';
        } else {
            alert('السلة فارغة');
        }
    });
}
// دالة جديدة لتحديث صورة المنتج
function updateProductImage(selectElement, productId) {
    const selectedImage = selectElement.value;
    const productContainer = selectElement.closest('.order-item');
    const imageElement = productContainer.querySelector('.product-image');
    imageElement.src = selectedImage;

    // تحديث الصورة المختارة في قاعدة البيانات
    database.ref(`carts/${userId}/${productId}/selectedImage`).set(selectedImage);
}

    </script>
</body>
</html>
